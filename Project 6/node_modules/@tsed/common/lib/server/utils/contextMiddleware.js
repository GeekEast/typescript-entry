"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const core_1 = require("@tsed/core");
const mvc_1 = require("../../mvc");
let AUTO_INCREMENT_ID = 1;
/**
 * Bind request and create a new context to store information during the request lifecycle
 * @param injector
 */
function contextMiddleware(injector) {
    const getId = injector.settings.logger.reqIdBuilder || (() => String(AUTO_INCREMENT_ID++));
    return (request, response, next) => tslib_1.__awaiter(this, void 0, void 0, function* () {
        request.ctx = new mvc_1.Context({ id: getId() });
        request.id = request.ctx.id;
        yield injector.emit("$onRequest", request, response);
        core_1.applyBefore(response, "end", () => tslib_1.__awaiter(this, void 0, void 0, function* () {
            yield injector.emit("$onResponse", request, response);
            yield request.ctx.destroy();
        }));
        next();
    });
}
exports.contextMiddleware = contextMiddleware;

//# sourceMappingURL=contextMiddleware.js.map
